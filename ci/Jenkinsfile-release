/**
 * Copyright (C) 2006-2024 Talend Inc. - www.talend.com
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
// Imports
import java.time.LocalDateTime
import java.util.regex.Matcher

// Credentials
final def ossrhCredentials = usernamePassword(
    credentialsId: 'ossrh-credentials',
    usernameVariable: 'OSSRH_USER',
    passwordVariable: 'OSSRH_PASS')
final def nexusCredentials = usernamePassword(
    credentialsId: 'nexus-artifact-zl-credentials',
    usernameVariable: 'NEXUS_USER', passwordVariable: 'NEXUS_PASS')
final def jetbrainsCredentials = usernamePassword(
    credentialsId: 'jetbrains-credentials',
    usernameVariable: 'JETBRAINS_USER',
    passwordVariable: 'JETBRAINS_PASS')
final def jiraCredentials = usernamePassword(
    credentialsId: 'jira-credentials',
    usernameVariable: 'JIRA_USER',
    passwordVariable: 'JIRA_PASS')
final def gitCredentials = usernamePassword(
    credentialsId: 'github-credentials',
    usernameVariable: 'GITHUB_USER',
    passwordVariable: 'GITHUB_PASS')
final def dockerCredentials = usernamePassword(
    credentialsId: 'artifactory-datapwn-credentials',
    usernameVariable: 'DOCKER_USER',
    passwordVariable: 'DOCKER_PASS')
final def sonarCredentials = usernamePassword(
    credentialsId: 'sonar-credentials',
    usernameVariable: 'SONAR_LOGIN',
    passwordVariable: 'SONAR_PASSWORD')
final def keyImportCredentials = usernamePassword(
    credentialsId: 'component-runtime-import-key-credentials',
    usernameVariable: 'KEY_USER',
    passwordVariable: 'KEY_PASS')
final def gpgCredentials = usernamePassword(
    credentialsId: 'component-runtime-gpg-credentials',
    usernameVariable: 'GPG_KEYNAME',
    passwordVariable: 'GPG_PASSPHRASE')

// In PR environment, the branch name is not valid and should be swap with pr name.
final String pull_request_id = env.CHANGE_ID
final String branch_name = pull_request_id != null ? env.CHANGE_BRANCH : env.BRANCH_NAME

// Job config
final Boolean isMasterBranch = branch_name == "master"
final Boolean isMaintenanceBranch = branch_name.startsWith("maintenance/")
final String extraBuildParams = ""

// Job variables declaration
String pomVersion          // Declared version in the pom file
String releaseVersion      // Released version for the release
String finalVersion        // Final version after the release
String tagName             // created git tag name
String maintenanceVersion  // Final version after the release for created maintenance branch
String maintenanceBranch   // created maintenance branch name

String skipOptions = "-Dspotless.apply.skip=true -Dcheckstyle.skip=true -Drat.skip=true -DskipTests -Dinvoker.skip=true"


pipeline {
  libraries {
    // Externals libraries used in this job
    // Connector lib from https://github.com/Talend/tdi-jenkins-shared-libraries
    lib("connectors-lib@main") // Defining jenkinsJobTools
  }

  agent {
    kubernetes {
      yamlFile '.jenkins/jenkins_pod.yml'
      defaultContainer 'main'
    }
  }

  environment {
    MAVEN_OPTS = "-Dformatter.skip=true -Dmaven.artifact.threads=256"
  }

  options {
    buildDiscarder(logRotator(artifactNumToKeepStr: '10', numToKeepStr: branch_name == 'master' ? '15' : '10'))
    timeout(time: 180, unit: 'MINUTES')
    skipStagesAfterUnstable()
  }

  triggers {
    cron(branch_name == "master" ? "0 12 * * *" : "")
  }

  parameters {
    choice(
        name: 'ACTION',
        choices: ['MILESTONE', 'GA'],
        description: """
          Type of release:
            MILESTONE: (default) classical milestone release 
              ex: 1.63.0M1 is release and master branch is bumped as 1.63.0M2
            GA: release for General Available
              ex: 1.63.0M9 is release as 1.63.0""")
    booleanParam(
        name: 'FAKE_RELEASE',
        defaultValue: true,
        description: '''For debug purposes, the job will deploy in:  
                        - Artifactory Dev instead of Artifactory Prod for docker images  
                        - Artifacts-zl instead of sonatype for java artefacts  
                        The job will not tag/commit on git''')
    string(
        name: 'EXTRA_BUILD_PARAMS',
        defaultValue: '',
        description: 'Add some extra parameters to maven commands. Applies to all maven calls.')
    booleanParam(
        name: 'JENKINS_DEBUG',
        defaultValue: false,
        description: 'Add an extra step to the pipeline allowing to keep the pod alive for debug purposes.')
  }

  stages {
    stage('Preliminary steps') {
      steps {

        ///////////////////////////////////////////
        // Login tasks
        ///////////////////////////////////////////
        script {
          withCredentials([gitCredentials]) {
            sh """ bash .jenkins/scripts/git_login.sh "\${GITHUB_USER}" "\${GITHUB_PASS}" """
          }
          withCredentials([dockerCredentials]) {
            // DOCKER_REGISTRY_HOST comes from global jenkins managed env var (in flux config)
            sh """ bash .jenkins/scripts/docker_login.sh "${DOCKER_REGISTRY_HOST}" "\${DOCKER_USER}" "\${DOCKER_PASS}" """
          }
          withCredentials([keyImportCredentials]) {
            sh """ bash .jenkins/scripts/setup_gpg.sh """
          }
        }
        ///////////////////////////////////////////
        // asdf install
        ///////////////////////////////////////////
        script {
          println "asdf install the content of repository .tool-versions'\n"
          sh 'bash .jenkins/scripts/asdf_install.sh'
        }

        ///////////////////////////////////////////
        // Variables init
        ///////////////////////////////////////////
        script {
          println "Variables init"

        }

        ///////////////////////////////////////////
        // Pom version management
        ///////////////////////////////////////////
        script{

            echo 'Read the actual version in the pom'
            final def pom = readMavenPom file: 'pom.xml'
            pomVersion = pom.version

            echo 'Manage the release version '
            //TODO
            releaseVersion = pomVersion

            echo 'Manage the final version after the release'
            //TODO
            finalVersion = pomVersion

        }
        ///////////////////////////////////////////
        // Updating build displayName and description
        ///////////////////////////////////////////
        script {
          jenkinsJobTools.job_name_creation($params.ACTION)

          // updating build description
          String description = """
            Execute a $params.Action release.  
            Debug: $params.JENKINS_DEBUG  
            Extra build args: $extraBuildParams  """.stripIndent()
          jenkinsJobTools.job_description_append(description)
        }
      }
    }

    stage('Post login') {
      steps {
        withCredentials([gitCredentials,
                         dockerCredentials,
                         ossrhCredentials,
                         jetbrainsCredentials,
                         jiraCredentials,
                         gpgCredentials]) {
          script {
              // TODO try not to use this
             sh """\
               #!/usr/bin/env bash
               bash .jenkins/scripts/npm_fix.sh
             """.stripIndent()
          }
        }
      }
    }

    stage('Version management') {
      steps {
        ///////////////////////////////////////////
        // Pom version management
        ///////////////////////////////////////////
        script{

          echo 'Read the actual version in the pom'
          final def pom = readMavenPom file: 'pom.xml'
          pomVersion = pom.version

          echo 'Manage the release version '
          (releaseVersion, finalVersion,
          maintenanceVersion, maintenanceBranch) = get_release_milestone_info(pomVersion, isMaintenanceBranch)
          tagName = "component-runtime-${releaseVersion}"
        }
        ///////////////////////////////////////////
        // Updating build displayName and description
        ///////////////////////////////////////////
        script {
          String user_name = currentBuild.getBuildCauses('hudson.model.Cause$UserIdCause').userId[0]
          if (user_name == null) {
            user_name = "auto"
          }

          currentBuild.displayName = (
              "#$currentBuild.number-$params.ACTION" + ": $user_name"
          )

          // updating build description
          String description = """
            Execute a $params.Action release.  
            Actual Version $pomVersion will be release as $releaseVersion.  
            After the release the repository will be bumped as $finalVersion  
            Debug: $params.JENKINS_DEBUG  
            Extra build args: $extraBuildParams""".stripIndent()
          jenkinsJobTools.job_description_append(description)
        }

      }
    }

    stage('Release') {
      steps {
        script {
          echo 'xxxx'
        }
      }
    }
  }
  post {
    success {
      script {
        println "====== Publish Coverage"
        publishCoverage adapters: [jacocoAdapter('**/jacoco-aggregate/*.xml')]
        publishCoverage adapters: [jacocoAdapter('**/jacoco-it/*.xml')]
        publishCoverage adapters: [jacocoAdapter('**/jacoco-ut/*.xml')]
        println "====== Publish HTML API Coverage"
        publishHTML([
            allowMissing         : false,
            alwaysLinkToLastBuild: false,
            keepAll              : true,
            reportDir            : 'reporting/target/site/jacoco-aggregate',
            reportFiles          : 'index.html',
            reportName           : 'Coverage',
            reportTitles         : 'Coverage'
        ])
      }
    }

    always {
      alertingTools.slack_result(
        env.SLACK_CI_CHANNEL,
        currentBuild.result,
        currentBuild.previousBuild.result,
        true, // Post for success and failure for release scripts
        true,
        "Failure of $pomVersion $params.Action release.")

      script {
        println '====== Archive jacoco reports artifacts'
        archiveArtifacts artifacts: "${'**/jacoco-aggregate/**/*.*'}", allowEmptyArchive: true, onlyIfSuccessful: false
      }

      script {
        if (params.JENKINS_DEBUG) {
          jenkinsJobTools.jenkinsBreakpoint()
        }
      }
    }
  }
}

/**
 * Assembly all needed items to put inside extraBuildParams
 *
 * @param Boolean skip_doc, if set to true documentation build will be skipped
 *
 * @return extraBuildParams as a string ready for mvn cmd
 */
private String assemblyExtraBuildParams() {
  String extraBuildParams

  println 'Processing extraBuildParams'
  final List<String> buildParamsAsArray = []

  println 'Manage user params'
  if (params.EXTRA_BUILD_PARAMS) {
    buildParamsAsArray.add(params.EXTRA_BUILD_PARAMS as String)
  }

  println 'Construct final params content'
  extraBuildParams = buildParamsAsArray.join(' ')

  println "extraBuildParams: $extraBuildParams"

  return extraBuildParams
}

private static ArrayList<String> get_release_milestone_info(String currentVersion, Boolean maintenance) {

  // Evaluate release name and tag from current version
  String releaseVersion = currentVersion.replaceAll("-SNAPSHOT", "") // TODO add replace M*

  // Get maj/min/rev
  def (maj, min, rev) = releaseVersion.tokenize('.').collect { it as int }

  // Calculate variables according to branch
  String maintenanceBranch = ""
  String maintenanceVersion = ""

  if (! maintenance) {
    // This is a release of main branch, the maintenance branch will need to be created.
    maintenanceBranch = "maintenance/${maj}.${min}"
    maintenanceVersion = "${maj}.${min}.${rev + 1}-SNAPSHOT"
    min++
    rev = 0
  } else {
    rev++
  }

  // Calculate the next development version
  String devVersion = "${maj}.${min}.${rev}-SNAPSHOT"

  return [releaseVersion, devVersion, maintenanceVersion, maintenanceBranch]
}
